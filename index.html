<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶Æ‡ßÅ‡¶¶‡¶ø ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡ßã - ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; font-family: 'Arial', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .nav-btn { padding: 8px 12px; border-radius: 8px; font-weight: 600; transition: all 0.3s; font-size: 14px; }
        .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        .active-tab { background-color: white !important; color: #312e81 !important; }

        .qty-input { width: 80px; border: 2px solid #cbd5e1; text-align: center; font-weight: bold; border-radius: 6px; }
        @media print { .no-print { display: none !important; } }
        
        /* ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #312e81; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .calc-card { background: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; margin: 20px auto; }
    </style>
</head>
<body>

    <!-- ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
    <div id="loader-overlay">
        <div class="spinner"></div>
        <p class="mt-4 font-bold text-indigo-900 animate-pulse">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <!-- ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶∞ -->
    <!-- ‡¶π‡ßá‡¶°‡¶æ‡¶∞ (Navigation) - ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶ó‡ßã‡¶õ‡¶æ‡¶®‡ßã ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® -->
<nav class="bg-indigo-950 text-white sticky top-0 z-50 shadow-2xl no-print">
    <div class="container mx-auto px-4 py-3">
        <!-- ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶Ç‡¶∂: ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ -->
        <div class="flex justify-between items-center border-b border-indigo-800 pb-2 mb-3">
            <div class="flex items-center gap-3">
                <div class="bg-white p-1.5 rounded-lg shadow-inner">
                    <span class="text-2xl">üõí</span>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-black leading-tight tracking-tight">‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶Æ‡ßÅ‡¶¶‡¶ø‡¶ñ‡¶æ‡¶®‡¶æ</h1>
                    <p class="text-[10px] uppercase tracking-widest text-indigo-300 font-bold">‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡ßã ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</p>
                </div>
            </div>
            
            <!-- ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
            <a href="https://wa.me/919832052828" target="_blank" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-full transition-all shadow-lg group">
                <span class="text-sm font-bold hidden sm:inline">WhatsApp:</span>
                <span class="text-xs md:text-sm font-black">+91 9832052828</span>
                <span class="animate-pulse">üí¨</span>
            </a>
        </div>
        
        <!-- ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶Ö‡¶Ç‡¶∂: ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π -->
        <div class="flex flex-wrap justify-center gap-2">
            <button id="btn-home" onclick="showTab('home')" class="nav-btn bg-indigo-800 flex-1 sm:flex-none text-center">‡¶π‡ßã‡¶Æ</button>
            <button id="btn-billing" onclick="showTab('billing')" class="nav-btn bg-emerald-600 flex-1 sm:flex-none text-center">‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç</button>
            <button id="btn-calc" onclick="showTab('calc')" class="nav-btn bg-amber-500 text-indigo-950 flex-1 sm:flex-none text-center">‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</button>
            <button id="admin-nav-btn" onclick="showTab('login')" class="nav-btn bg-rose-600 flex-1 sm:flex-none text-center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® üîí</button>
            <button id="logout-btn" class="hidden nav-btn bg-slate-700 flex-1 sm:flex-none text-center">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
        </div>
    </div>
</nav>

    <div class="container mx-auto p-4">

        <!-- ‡ßß. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶™‡ßá‡¶ú -->
        <div id="calc" class="tab-content no-print">
            <div class="max-w-xl mx-auto space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-indigo-600">
                    <h2 class="text-xl font-bold text-indigo-900 mb-4">‚öñÔ∏è ‡¶ì‡¶ú‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡¶æ‡¶Æ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="number" id="rate-to-price" oninput="calcWeightToPrice()" placeholder="‡ßß ‡¶ï‡ßá‡¶ú‡¶ø‡¶∞ ‡¶¶‡¶æ‡¶Æ" class="w-full p-3 border-2 rounded-xl outline-none font-bold">
                        <div class="flex">
                            <input type="number" id="weight-input" oninput="calcWeightToPrice()" placeholder="‡¶ì‡¶ú‡¶®" class="w-full p-3 border-2 rounded-l-xl outline-none font-bold">
                            <select id="weight-unit" onchange="calcWeightToPrice()" class="bg-slate-100 border-2 p-3 rounded-r-xl font-bold">
                                <option value="gram">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</option>
                                <option value="kg">‡¶ï‡ßá‡¶ú‡¶ø</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 bg-indigo-900 p-4 rounded-xl text-center text-white">
                        <div class="text-3xl font-black">‚Çπ <span id="res-total-price">0.00</span></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-green-600">
                    <h2 class="text-xl font-bold text-green-900 mb-4">üí∞ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶ì‡¶ú‡¶®</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="number" id="rate-to-weight" oninput="calcMoneyToWeight()" placeholder="‡ßß ‡¶ï‡ßá‡¶ú‡¶ø‡¶∞ ‡¶¶‡¶æ‡¶Æ" class="w-full p-3 border-2 rounded-xl outline-none font-bold">
                        <input type="number" id="money-input" oninput="calcMoneyToWeight()" placeholder="‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶≤?" class="w-full p-3 border-2 rounded-xl outline-none font-bold">
                    </div>
                    <div class="mt-4 bg-green-600 p-4 rounded-xl text-center text-white">
                        <div class="text-3xl font-black"><span id="res-total-weight">0.00</span> ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</div>
                        <div id="res-kg-hint" class="text-xs">‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡ß®. ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú -->
        <div id="login" class="tab-content no-print">
            <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl mt-10 border-t-8 border-indigo-900 text-center">
                <h2 class="text-2xl font-bold mb-6">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶®</h2>
                <input type="email" id="login-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full p-3 mb-4 border rounded-xl outline-none">
                <input type="password" id="login-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full p-3 mb-6 border rounded-xl outline-none">
                <button id="btn-login" class="w-full bg-indigo-900 text-white py-3 rounded-xl font-bold">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

        <!-- ‡ß©. ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú -->
        <div id="home" class="tab-content active no-print">
            <input type="text" id="search-home" oninput="renderApp()" placeholder="‡¶Æ‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-4 mb-6 rounded-xl border-2 border-indigo-200 outline-none shadow-sm">
            <div id="home-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>

        <!-- ‡ß™. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßá‡¶ú (‡¶è‡¶°‡¶ø‡¶ü ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∏‡¶π) -->
        <div id="admin" class="tab-content no-print">
            <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-red-600 mb-8">
                <h2 id="admin-form-title" class="font-bold text-2xl mb-6">‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡¶æ‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="text-xs font-bold text-gray-400">‡¶Æ‡¶æ‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="p-name" placeholder="‡¶®‡¶æ‡¶Æ" class="w-full border-2 p-3 rounded-xl outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400">‡¶¶‡¶æ‡¶Æ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                        <div class="flex">
                            <input type="number" step="any" id="p-price" placeholder="‡¶¶‡¶æ‡¶Æ" class="border-2 p-3 rounded-l-xl w-full outline-none">
                            <select id="p-unit" class="border-2 p-3 rounded-r-xl bg-slate-100 font-bold">
                                <option value="‡¶ï‡ßá‡¶ú‡¶ø">‡¶ï‡ßá‡¶ú‡¶ø</option>
                                <option value="‡ßß‡ß¶‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ">‡ßß‡ß¶‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</option>
                                <option value="‡ß®‡ß´‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ">‡ß®‡ß´‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</option>
                                <option value="‡ß´‡ß¶‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ">‡ß´‡ß¶‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</option>
                                <option value="‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü">‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü</option>
                                <option value="‡¶¨‡¶∏‡ßç‡¶§‡¶æ">‡¶¨‡¶∏‡ßç‡¶§‡¶æ</option>
                                <option value="‡¶™‡¶ø‡¶∏">‡¶™‡¶ø‡¶∏</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400">‡¶õ‡¶¨‡¶ø (Camera/Gallery)</label>
                        <input type="file" id="p-image" accept="image/*" class="w-full border-2 p-2 rounded-xl text-xs">
                    </div>
                    <div class="flex gap-2">
                        <button id="add-btn" class="flex-1 bg-indigo-900 text-white py-3.5 rounded-xl font-bold">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        <button id="cancel-edit" class="hidden bg-gray-500 text-white px-4 rounded-xl font-bold">X</button>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-md overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-white text-xs">
                        <tr><th class="p-4">‡¶®‡¶æ‡¶Æ</th><th class="p-4">‡¶¶‡¶æ‡¶Æ</th><th class="p-4 text-right">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr>
                    </thead>
                    <tbody id="admin-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- ‡ß´. ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶™‡ßá‡¶ú -->
        <div id="billing" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 no-print">
                    <input type="text" id="search-billing" oninput="renderApp()" placeholder="‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 mb-4 border-2 border-green-500 rounded-xl outline-none">
                    <div id="billing-product-list" class="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto pr-2"></div>
                </div>
                <div class="lg:col-span-2">
                    <div id="bill-print-area" class="bg-white p-6 md:p-10 rounded-2xl shadow-2xl border">
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-black text-indigo-950 uppercase">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Æ‡ßá‡¶Æ‡ßã</h2>
                            <p class="text-slate-500 font-bold mt-2">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <span id="bill-date"></span></p>
                            <div class="border-b-4 border-double border-slate-900 mt-4"></div>
                        </div>
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-slate-900 font-bold text-sm">
                                    <th class="text-left py-4">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                    <th class="text-center py-4">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                    <th class="text-right py-4">‡¶ü‡¶æ‡¶ï‡¶æ</th>
                                    <th class="no-print w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="cart-body"></tbody>
                        </table>
                        <div class="mt-8 flex justify-between items-center border-t-4 border-double border-slate-900 pt-6">
                            <span class="text-xl font-bold">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ:</span>
                            <span class="text-3xl font-black text-red-600">‚Çπ <span id="grand-total">0</span></span>
                        </div>
                    </div>
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
                        <button onclick="window.print()" class="bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                        <button onclick="shareOnWhatsApp()" class="bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg">üì± ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™</button>
                        <button onclick="clearCart()" class="bg-slate-200 text-slate-600 py-4 rounded-xl font-bold">üóëÔ∏è ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶Ö‡¶Ç‡¶∂ -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ‡ßß. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyC_gF61oUKnwn8wa-yVMioRKhPTf8O3o8g",
        authDomain: "mudidokan-app.firebaseapp.com",
        projectId: "mudidokan-app",
        storageBucket: "mudidokan-app.firebasestorage.app",
        messagingSenderId: "109112256960",
        appId: "1:109112256960:web:d7a2ae959790d17bc04025",
        measurementId: "G-3VFKMPV418"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const productsRef = ref(db, 'products');

    let products = [];
    let cart = [];
    let currentUser = null;
    let editMode = false;
    let editId = null;
    let isInitialLoad = true; // ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

    // ‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
    setPersistence(auth, browserLocalPersistence);

    // ‡ß®. ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï (‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï)
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        const btn = document.getElementById('admin-nav-btn');
        const logout = document.getElementById('logout-btn');
        
        if (user) {
            btn.innerHTML = "‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‚úÖ";
            btn.onclick = () => showTab('admin');
            logout.classList.remove('hidden');
        } else {
            btn.innerHTML = "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® üîí";
            btn.onclick = () => showTab('login');
            logout.classList.add('hidden');
        }

        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
        if (isInitialLoad) {
            showTab('home');
            isInitialLoad = false;
        }
    });

    // ‡ß©. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶®‡¶æ
    onValue(productsRef, (snapshot) => {
        const data = snapshot.val();
        products = [];
        if(data) Object.keys(data).forEach(k => products.push({id: k, ...data[k]}));
        renderApp();
        document.getElementById('loader-overlay').style.display = 'none';
    });

    // ‡ß™. ‡¶≤‡¶ó‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
    document.getElementById('btn-login').onclick = () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        if(!email || !pass) return alert("‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®");
        
        signInWithEmailAndPassword(auth, email, pass)
            .then(() => { alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤!"); showTab('admin'); })
            .catch(() => alert("‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!"));
    };

    // ‡ß´. ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï
    document.getElementById('logout-btn').onclick = () => {
        if(confirm("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            signOut(auth).then(() => { alert("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); showTab('home'); });
        }
    };

    // ‡ß¨. ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡ßÅ‡¶á‡¶ö‡¶ø‡¶Ç (‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶)
    window.showTab = function(id) {
        // ‡¶Ø‡¶¶‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ
        if(id === 'admin' && !currentUser) {
            showTab('login');
            return;
        }
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-tab'));
        
        document.getElementById(id).classList.add('active');
        const activeBtn = document.getElementById('btn-'+id) || (id === 'admin' ? document.getElementById('admin-nav-btn') : null);
        if(activeBtn) activeBtn.classList.add('active-tab');
        
        document.getElementById('bill-date').innerText = new Date().toLocaleDateString('bn-BD');
        renderApp();
    };

    // ‡ß≠. ‡¶á‡¶Æ‡ßá‡¶ú ‡¶ï‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡ßá‡¶∂‡¶®
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400; canvas.height = img.height * (400 / img.width);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.5));
                };
            };
        });
    }

    // ‡ßÆ. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßá‡¶≠/‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    document.getElementById('add-btn').onclick = async function() {
        if(!currentUser) return alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!");
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        const unit = document.getElementById('p-unit').value;
        const file = document.getElementById('p-image').files[0];
        const btn = document.getElementById('add-btn');

        if(!name || !price) return alert("‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶¶‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®");
        btn.innerText = "‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®..."; btn.disabled = true;

        let imgData = editMode ? products.find(p => p.id === editId).image : "";
        if(file) imgData = await compressImage(file);

        const data = { name, price: parseFloat(price), unit, image: imgData, visible: true };

        if(editMode) {
            update(ref(db, 'products/' + editId), data).then(() => { alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); resetAdminForm(); });
        } else {
            push(productsRef, data).then(() => { alert("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); resetAdminForm(); });
        }
    };

    window.editP = (id) => {
        const p = products.find(i => i.id === id);
        editMode = true; editId = id;
        document.getElementById('p-name').value = p.name;
        document.getElementById('p-price').value = p.price;
        document.getElementById('p-unit').value = p.unit;
        document.getElementById('admin-form-title').innerText = "‡¶Æ‡¶æ‡¶≤ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('add-btn').innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('cancel-edit').classList.remove('hidden');
        window.scrollTo(0,0);
    };

    function resetAdminForm() {
        editMode = false; editId = null;
        document.getElementById('p-name').value = ''; document.getElementById('p-price').value = '';
        document.getElementById('admin-form-title').innerText = "‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡¶æ‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('add-btn').innerText = "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('add-btn').disabled = false;
        document.getElementById('cancel-edit').classList.add('hidden');
    }
    document.getElementById('cancel-edit').onclick = resetAdminForm;

    // ‡ßØ. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
    window.calcWeightToPrice = () => {
        let r = parseFloat(document.getElementById('rate-to-price').value) || 0;
        let q = parseFloat(document.getElementById('weight-input').value) || 0;
        let u = document.getElementById('weight-unit').value;
        let res = (u === "kg") ? r * q : (r / 1000) * q;
        document.getElementById('res-total-price').innerText = res.toFixed(2);
    };

    window.calcMoneyToWeight = () => {
        let r = parseFloat(document.getElementById('rate-to-weight').value) || 0;
        let m = parseFloat(document.getElementById('money-input').value) || 0;
        if(r > 0 && m > 0) {
            let g = (m / r) * 1000;
            document.getElementById('res-total-weight').innerText = g >= 1000 ? (g/1000).toFixed(2) + " ‡¶ï‡ßá‡¶ú‡¶ø" : Math.round(g) + " ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ";
            document.getElementById('res-kg-hint').innerText = g.toFixed(2) + " ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ (‡¶®‡¶ø‡¶ñ‡ßÅ‡¶Å‡¶§)";
        }
    };

    // ‡ßß‡ß¶. ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ UI
    window.renderApp = function() {
        const hS = document.getElementById('search-home').value.toLowerCase();
        const bS = document.getElementById('search-billing').value.toLowerCase();

        const hL = document.getElementById('home-list'); hL.innerHTML = '';
        products.filter(p => p.visible && p.name.toLowerCase().includes(hS)).forEach(p => {
            hL.innerHTML += `<div class="bg-white p-2 rounded-xl shadow-sm text-center border">
                <img src="${p.image || ''}" loading="lazy" class="h-20 w-full object-cover rounded-lg mb-1 bg-gray-100">
                <p class="font-bold text-xs truncate">${p.name}</p>
                <p class="text-indigo-600 font-black text-sm">‚Çπ${p.price}/${p.unit}</p>
            </div>`;
        });

        const aT = document.getElementById('admin-table-body'); aT.innerHTML = '';
        products.forEach(p => {
            aT.innerHTML += `<tr class="border-b text-sm">
                <td class="p-4 font-bold text-slate-700">${p.name}</td>
                <td class="p-4">‚Çπ${p.price}/${p.unit}</td>
                <td class="p-4 text-right flex gap-1 justify-end">
                    <button onclick="editP('${p.id}')" class="bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold">Edit</button>
                    <button onclick="toggleV('${p.id}')" class="bg-gray-100 px-2 py-1 rounded font-bold">${p.visible?'Hide':'Show'}</button>
                    <button onclick="delP('${p.id}')" class="bg-red-100 text-red-600 px-2 py-1 rounded font-bold">Del</button>
                </td>
            </tr>`;
        });

        const bL = document.getElementById('billing-product-list'); bL.innerHTML = '';
        products.filter(p => p.visible && p.name.toLowerCase().includes(bS)).forEach(p => {
            bL.innerHTML += `<button onclick="addToCart('${p.id}')" class="bg-white p-3 text-left border rounded-xl shadow-sm font-bold text-sm">
                ${p.name}<div class="text-[10px] text-slate-400 font-black uppercase">‚Çπ${p.price}/${p.unit}</div>
            </button>`;
        });
        updateBillTable();
    };

    window.delP = (id) => { if(currentUser && confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) remove(ref(db, 'products/'+id)); };
    window.toggleV = (id) => { 
        if(!currentUser) return;
        const p = products.find(i => i.id === id);
        update(ref(db, 'products/'+id), { visible: !p.visible }); 
    };

    // ‡ßß‡ßß. ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï
    window.addToCart = (pid) => { 
        const p = products.find(i => i.id === pid); 
        cart.push({...p, cartId: Date.now(), qty: 1, total: p.price.toFixed(2)}); 
        updateBillTable(); 
    };

    window.updateQty = (id, val) => { 
        const i = cart.find(x => x.cartId === id); 
        if(i) { 
            i.qty = val; 
            i.total = (i.price * (parseFloat(val) || 0)).toFixed(2); 
            // ‡¶¶‡¶∂‡¶Æ‡¶ø‡¶ï ‡¶≤‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∞‡¶ø-‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            const totalSpan = document.getElementById(`total-${id}`);
            if(totalSpan) totalSpan.innerText = i.total;
            let gt = 0; cart.forEach(x => gt += parseFloat(x.total));
            document.getElementById('grand-total').innerText = gt.toFixed(2);
        } 
    };

    window.updateBillTable = () => {
        const b = document.getElementById('cart-body'); let gt = 0; b.innerHTML = '';
        cart.forEach(i => { 
            gt += parseFloat(i.total); 
            b.innerHTML += `<tr class="border-b">
                <td class="py-4 font-bold text-xs">${i.name}</td>
                <td class="text-center py-4">
                    <input type="number" step="any" value="${i.qty}" oninput="updateQty(${i.cartId}, this.value)" class="qty-input no-print font-bold text-indigo-700"> 
                    <span class="hidden print:inline">${i.qty}</span> ${i.unit}
                </td>
                <td class="text-right font-black text-sm">‚Çπ<span id="total-${i.cartId}">${i.total}</span></td>
                <td class="no-print text-right"><button onclick="removeCartItem(${i.cartId})" class="text-red-400 text-2xl">√ó</button></td>
            </tr>`; 
        });
        document.getElementById('grand-total').innerText = gt.toFixed(2);
    };

    window.removeCartItem = (id) => { cart = cart.filter(x => x.cartId !== id); updateBillTable(); };
    window.clearCart = () => { if(confirm("‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) { cart = []; updateBillTable(); } };

    // ‡ßß‡ß®. ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶Æ‡ßá‡¶Æ‡ßã
    window.shareOnWhatsApp = () => {
        if(cart.length === 0) return alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!");
        let m = `*‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®*\n*WHATSAPP-NO: +91 9832052828*\n`;
        m += `‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date().toLocaleDateString('bn-BD')}\n`;
        m += `----------------------------\n`;
        cart.forEach((i, x) => m += `${x+1}. *${i.name}* : ${i.qty} ${i.unit} = ‚Çπ${i.total}\n`);
        m += `----------------------------\n*‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü: ‚Çπ${document.getElementById('grand-total').innerText}*\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶, ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶∏‡¶¨‡ßá‡¶®!`;
        window.open(`https://wa.me/?text=${encodeURIComponent(m)}`, '_blank');
    };

</script>
</body>
</html>


