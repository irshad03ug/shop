<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶Æ‡ßÅ‡¶¶‡¶ø ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡ßã - ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; font-family: 'Arial', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .nav-btn {
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        .active-tab { background-color: white !important; color: #312e81 !important; }

        .qty-input { width: 80px; border: 2px solid #cbd5e1; text-align: center; font-weight: bold; border-radius: 6px; }
        @media print { .no-print { display: none !important; } }
        
        /* ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .calc-card {
            background: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 20px auto;
        }
    </style>
</head>
<body>

    <!-- ‡¶π‡ßá‡¶°‡¶æ‡¶∞ (Navigation) - ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶ó‡ßã‡¶õ‡¶æ‡¶®‡ßã ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
    <nav class="bg-indigo-900 text-white sticky top-0 z-50 shadow-xl no-print">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üõí</span>
                    <h1 class="text-lg font-black tracking-tight leading-tight">‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡ßã</h1>
                </div>
                
                <div class="flex flex-wrap justify-center gap-2">
                    <button id="btn-home" onclick="showTab('home')" class="nav-btn bg-indigo-800">‡¶π‡ßã‡¶Æ</button>
                    <button id="btn-billing" onclick="showTab('billing')" class="nav-btn bg-green-600">‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç</button>
                    <button id="btn-calc" onclick="showTab('calc')" class="nav-btn bg-yellow-500 text-indigo-900">‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</button>
                    <button id="admin-nav-btn" onclick="showTab('login')" class="nav-btn bg-red-600">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® üîí</button>
                    <button id="logout-btn" class="hidden nav-btn bg-gray-700">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4">

        <!-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶™‡ßá‡¶ú (‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶°‡ßá‡¶°) -->
<div id="calc" class="tab-content no-print">
    <div class="calc-card border-t-8 border-yellow-500">
        <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶¶‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</h2>
        
        <div class="space-y-4">
            <!-- ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡ßß: ‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ -->
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">‡¶™‡ßÅ‡¶∞‡ßã ‡¶¶‡¶æ‡¶Æ (‡¶ü‡¶æ‡¶ï‡¶æ)</label>
                <input type="number" id="calc-total-price" oninput="calculateAdvancedPrice()" placeholder="‡¶â‡¶¶‡¶æ: ‡ß®‡ß©‡ß™" 
                class="w-full text-2xl p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 outline-none text-center font-bold text-indigo-900">
            </div>

            <!-- ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡ß®: ‡¶ï‡¶§ ‡¶ï‡ßá‡¶ú‡¶ø‡¶∞ ‡¶¶‡¶æ‡¶Æ -->
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">‡¶ï‡¶§ ‡¶ï‡ßá‡¶ú‡¶ø‡¶∞ ‡¶¶‡¶æ‡¶Æ ‡¶è‡¶ü‡¶ø?</label>
                <input type="number" id="calc-qty" oninput="calculateAdvancedPrice()" placeholder="‡¶â‡¶¶‡¶æ: ‡ß©" 
                class="w-full text-2xl p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 outline-none text-center font-bold text-indigo-900">
            </div>
        </div>

        <div class="mt-8 grid grid-cols-2 gap-4">
            <!-- ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡ßß: ‡ßß ‡¶ï‡ßá‡¶ú‡¶ø -->
            <div class="bg-indigo-50 p-4 rounded-2xl text-center">
                <span class="block text-gray-500 text-[10px] font-bold uppercase mb-1">‡ßß ‡¶ï‡ßá‡¶ú‡¶ø‡¶∞ ‡¶¶‡¶æ‡¶Æ</span>
                <div class="text-2xl font-black text-indigo-700">‚Çπ <span id="res-per-kg">0</span></div>
            </div>
            <!-- ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡ß®: ‡ßß‡ß¶‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ -->
            <div class="bg-green-50 p-4 rounded-2xl text-center">
                <span class="block text-gray-500 text-[10px] font-bold uppercase mb-1">‡ßß‡ß¶‡ß¶ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Æ</span>
                <div class="text-2xl font-black text-green-700">‚Çπ <span id="res-per-100g">0</span></div>
            </div>
        </div>
        
        <!-- ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶π‡¶æ‡¶´ ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ ‡¶Ö‡¶™‡¶∂‡¶®‡¶ü‡¶ø‡¶ì ‡¶®‡¶ø‡¶ö‡ßá ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã -->
        <div class="mt-4 bg-gray-50 p-3 rounded-xl text-center border-dashed border-2">
            <span class="text-xs font-bold text-gray-400">‡¶Ö‡¶∞‡ßç‡¶ß‡ßá‡¶ï ‡¶¶‡¶æ‡¶Æ (‡¶ê ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞): ‚Çπ <span id="res-half">0</span></span>
        </div>
    </div>
</div>
        <!-- ‡ß®. ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú -->
        <div id="login" class="tab-content no-print">
            <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl mt-10 border-t-8 border-indigo-900">
                <h2 class="text-2xl font-bold mb-6 text-center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶®</h2>
                <input type="email" id="login-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full p-3 mb-4 border rounded-xl outline-none focus:border-indigo-500">
                <input type="password" id="login-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full p-3 mb-6 border rounded-xl outline-none focus:border-indigo-500">
                <button id="btn-login" class="w-full bg-indigo-900 text-white py-3 rounded-xl font-bold hover:bg-black transition">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

        <!-- ‡ß©. ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú -->
        <div id="home" class="tab-content active no-print">
            <input type="text" id="search-home" oninput="renderApp()" placeholder="‡¶Æ‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-4 mb-6 rounded-xl border-2 border-indigo-200 outline-none shadow-sm focus:border-indigo-500">
            <div id="home-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>

       <!-- ‡ß™. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßá‡¶ú -->
<div id="admin" class="tab-content no-print">
    <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-red-600 mb-8">
        <h2 class="font-bold text-2xl mb-6 text-slate-800">‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡¶æ‡¶≤ ‡¶Ø‡ßã‡¶ó</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <!-- ‡¶®‡¶æ‡¶Æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü -->
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">‡¶Æ‡¶æ‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                <input type="text" id="p-name" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="w-full border-2 p-3 rounded-xl outline-none focus:border-indigo-500">
            </div>
            
            <!-- ‡¶¶‡¶æ‡¶Æ ‡¶ì ‡¶á‡¶â‡¶®‡¶ø‡¶ü -->
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">‡¶¶‡¶æ‡¶Æ ‡¶ì ‡¶á‡¶â‡¶®‡¶ø‡¶ü</label>
                <div class="flex">
                    <input type="number" step="any" id="p-price" placeholder="‡¶¶‡¶æ‡¶Æ" class="border-2 p-3 rounded-l-xl w-full outline-none focus:border-indigo-500">
                    <select id="p-unit" class="border-2 p-3 rounded-r-xl bg-slate-100 font-bold uppercase outline-none">
                        <option value="‡¶ï‡ßá‡¶ú‡¶ø">‡¶ï‡ßá‡¶ú‡¶ø</option>
                        <option value="‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü">‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü</option>
                        <option value="‡¶¨‡¶∏‡ßç‡¶§‡¶æ">‡¶¨‡¶∏‡ßç‡¶§‡¶æ</option>
                        <option value="‡¶™‡¶ø‡¶∏">‡¶™‡¶ø‡¶∏</option>
                    </select>
                </div>
            </div>

            <!-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ì ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø ‡¶õ‡¶¨‡¶ø -->
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">‡¶õ‡¶¨‡¶ø (‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ/‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø)</label>
                <input type="file" id="p-image" accept="image/*" class="w-full border-2 p-2 rounded-xl outline-none bg-slate-50 text-xs">
            </div>

            <!-- ‡¶∏‡ßá‡¶≠ ‡¶¨‡¶æ‡¶ü‡¶® -->
            <button id="add-btn" class="bg-indigo-900 text-white py-3.5 rounded-xl font-bold hover:bg-black transition-all shadow-md">
                ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>
    </div>

    <!-- ‡¶Æ‡¶æ‡¶≤‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ -->
    <div class="bg-white rounded-2xl shadow-md overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-slate-800 text-white text-sm">
                <tr><th class="p-4">‡¶®‡¶æ‡¶Æ</th><th class="p-4">‡¶¶‡¶æ‡¶Æ</th><th class="p-4 text-right">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr>
            </thead>
            <tbody id="admin-table-body"></tbody>
        </table>
    </div>
</div>
        <!-- ‡ß´. ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶™‡ßá‡¶ú -->
        <div id="billing" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 no-print">
                    <input type="text" id="search-billing" oninput="renderApp()" placeholder="‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 mb-4 border-2 border-green-500 rounded-xl outline-none">
                    <div id="billing-product-list" class="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto pr-2"></div>
                </div>

                <div class="lg:col-span-2">
                    <div id="bill-print-area" class="bg-white p-6 md:p-10 rounded-2xl shadow-2xl border border-slate-200">
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-black text-indigo-950 uppercase">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Æ‡ßá‡¶Æ‡ßã</h2>
                            <p class="text-slate-500 font-bold mt-2">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <span id="bill-date"></span></p>
                            <div class="border-b-4 border-double border-slate-900 mt-4"></div>
                        </div>
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-slate-900 font-bold text-sm">
                                    <th class="text-left py-4">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                    <th class="text-center py-4">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                    <th class="text-right py-4">‡¶ü‡¶æ‡¶ï‡¶æ</th>
                                    <th class="no-print w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="cart-body"></tbody>
                        </table>
                        <div class="mt-8 flex justify-between items-center border-t-4 border-double border-slate-900 pt-6">
                            <span class="text-xl font-bold">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ:</span>
                            <span class="text-3xl font-black text-red-600">‚Çπ <span id="grand-total">0</span></span>
                        </div>
                    </div>
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
                        <button onclick="window.print()" class="bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                        <button onclick="shareOnWhatsApp()" class="bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg">üì± ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™</button>
                        <button onclick="clearCart()" class="bg-slate-200 text-slate-600 py-4 rounded-xl font-bold">üóëÔ∏è ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- FIREBASE MODULES -->
    <!-- FIREBASE & APP LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ‡ßß. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyC_gF61oUKnwn8wa-yVMioRKhPTf8O3o8g",
        authDomain: "mudidokan-app.firebaseapp.com",
        projectId: "mudidokan-app",
        storageBucket: "mudidokan-app.firebasestorage.app",
        messagingSenderId: "109112256960",
        appId: "1:109112256960:web:d7a2ae959790d17bc04025",
        measurementId: "G-3VFKMPV418"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const productsRef = ref(db, 'products');

    let products = [];
    let cart = [];
    let currentUser = null;

    setPersistence(auth, browserLocalPersistence);

    // ‡ß®. ‡¶á‡¶Æ‡ßá‡¶ú ‡¶ï‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶õ‡¶¨‡¶ø ‡ß´‡ß¶ KB-‡¶∞ ‡¶Ü‡¶∂‡ßá‡¶™‡¶æ‡¶∂‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá)
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 400; // ‡¶∏‡¶æ‡¶á‡¶ú ‡¶õ‡ßã‡¶ü ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡ß¶.‡ß´ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶∏‡¶æ‡¶á‡¶ú ‡¶Ö‡¶®‡ßá‡¶ï ‡¶ï‡¶Æ‡ßá ‡¶Ø‡¶æ‡ßü (‡¶™‡ßç‡¶∞‡¶æ‡ßü ‡ß®‡ß¶-‡ß™‡ß¶ KB ‡¶π‡¶¨‡ßá)
                    resolve(canvas.toDataURL('image/jpeg', 0.5));
                };
            };
        });
    }

    // ‡ß©. ‡¶≤‡¶ó‡¶á‡¶® ‡¶ö‡ßá‡¶ï
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        const btn = document.getElementById('admin-nav-btn');
        const logout = document.getElementById('logout-btn');
        if (user) {
            btn.innerText = "‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‚úÖ";
            btn.onclick = () => showTab('admin');
            logout.classList.remove('hidden');
        } else {
            btn.innerText = "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® üîí";
            btn.onclick = () => showTab('login');
            logout.classList.add('hidden');
        }
    });

    // ‡ß™. ‡¶≤‡¶ó‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
    document.getElementById('btn-login').onclick = () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        signInWithEmailAndPassword(auth, email, pass)
            .then(() => { alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤!"); showTab('admin'); })
            .catch(() => alert("‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"));
    };

    document.getElementById('logout-btn').onclick = () => {
        if(confirm("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) signOut(auth).then(() => showTab('home'));
    };

    // ‡ß´. ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ì ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞
    window.showTab = function(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('bill-date').innerText = new Date().toLocaleDateString('bn-BD');
        renderApp();
    };

    window.calculateAdvancedPrice = function() {
        let price = parseFloat(document.getElementById('calc-total-price').value) || 0;
        let qty = parseFloat(document.getElementById('calc-qty').value) || 0;
        document.getElementById('res-per-kg').innerText = qty > 0 ? (price / qty).toFixed(2) : "0";
        document.getElementById('res-per-100g').innerText = qty > 0 ? (price / qty / 10).toFixed(2) : "0";
        document.getElementById('res-half').innerText = (price / 2).toFixed(2);
    };

    // ‡ß¨. Firebase ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° (‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Ü‡¶ó‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá)
    onValue(productsRef, (snapshot) => {
        const data = snapshot.val();
        products = [];
        if(data) Object.keys(data).forEach(k => products.push({id: k, ...data[k]}));
        renderApp();
    });

    // ‡ß≠. ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡¶æ‡¶≤ ‡¶Ø‡ßã‡¶ó (Compression ‡¶∏‡¶π)
    document.getElementById('add-btn').onclick = async function() {
        if(!currentUser) return alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!");
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        const unit = document.getElementById('p-unit').value;
        const file = document.getElementById('p-image').files[0] || document.getElementById('p-camera').files[0];
        const btn = document.getElementById('add-btn');

        if(!name || !price) return alert("‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®");
        
        btn.innerText = "‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        btn.disabled = true;

        let imgData = "";
        if(file) imgData = await compressImage(file);

        push(productsRef, { name, price: parseFloat(price), unit, image: imgData, visible: true })
        .then(() => {
            alert("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
            btn.innerText = "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®";
            btn.disabled = false;
        });
    };

    // ‡ßÆ. ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ì ‡¶π‡¶æ‡¶á‡¶°
    window.delP = (id) => { if(currentUser && confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) remove(ref(db, 'products/'+id)); };
    window.toggleV = (id) => { 
        const p = products.find(i => i.id === id);
        if(currentUser) update(ref(db, 'products/'+id), { visible: !p.visible });
    };

    // ‡ßØ. UI ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ (Lazy Loading Feel)
    window.renderApp = function() {
        const hS = document.getElementById('search-home').value.toLowerCase();
        const bS = document.getElementById('search-billing').value.toLowerCase();

        // ‡¶π‡ßã‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
        const hList = document.getElementById('home-list'); 
        hList.innerHTML = '';
        products.filter(p => p.visible && p.name.toLowerCase().includes(hS)).forEach(p => {
            hList.innerHTML += `
                <div class="bg-white p-2 rounded-xl shadow-sm text-center border">
                    <img src="${p.image || ''}" loading="lazy" class="h-20 w-full object-cover rounded-lg mb-1 bg-gray-100" alt="..">
                    <p class="font-bold text-xs">${p.name}</p>
                    <p class="text-indigo-600 font-black text-sm">‚Çπ ${p.price}/${p.unit}</p>
                </div>`;
        });

        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤
        const aTable = document.getElementById('admin-table-body'); 
        aTable.innerHTML = '';
        products.forEach(p => {
            aTable.innerHTML += `<tr class="border-b text-sm"><td class="p-4 font-bold">${p.name}</td><td class="p-4">‚Çπ ${p.price}</td><td class="p-4 text-right"><button onclick="toggleV('${p.id}')" class="px-2 py-1 rounded ${p.visible ? 'bg-orange-100' : 'bg-green-100'}">${p.visible?'Hide':'Show'}</button> <button onclick="delP('${p.id}')" class="bg-red-100 text-red-600 px-2 py-1 rounded ml-1">Del</button></td></tr>`;
        });

        // ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
        const bList = document.getElementById('billing-product-list'); 
        bList.innerHTML = '';
        products.filter(p => p.visible && p.name.toLowerCase().includes(bS)).forEach(p => {
            bList.innerHTML += `<button onclick="addToCart('${p.id}')" class="bg-white p-3 text-left border rounded-xl shadow-sm hover:border-green-500 font-bold text-sm">
                ${p.name}<div class="text-[10px] text-slate-400 font-black uppercase">‚Çπ ${p.price}/${p.unit}</div>
            </button>`;
        });
        updateBillTable();
    };

    // ‡ßß‡ß¶. ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶ì ‡¶¶‡¶∂‡¶Æ‡¶ø‡¶ï ‡¶ì‡¶ú‡¶® (FIXED)
    window.addToCart = (pid) => { 
        const p = products.find(i => i.id === pid); 
        cart.push({...p, cartId: Date.now(), qty: 1, total: p.price.toFixed(2)}); 
        updateBillTable(); 
    };

    window.updateQty = (id, val) => { 
        const item = cart.find(x => x.cartId === id); 
        if(!item) return;
        item.qty = val;
        item.total = (item.price * (parseFloat(val) || 0)).toFixed(2); 
        document.getElementById(`total-${id}`).innerText = item.total;
        let gt = 0;
        cart.forEach(x => gt += parseFloat(x.total));
        document.getElementById('grand-total').innerText = gt.toFixed(2);
    };

    window.updateBillTable = () => {
        const b = document.getElementById('cart-body'); 
        let gt = 0; b.innerHTML = '';
        cart.forEach(i => { 
            gt += parseFloat(i.total); 
            b.innerHTML += `
                <tr class="border-b">
                    <td class="py-4 font-bold text-xs">${i.name}</td>
                    <td class="text-center py-4">
                        <input type="number" step="any" value="${i.qty}" oninput="updateQty(${i.cartId}, this.value)" class="qty-input no-print font-bold text-indigo-700">
                        <span class="hidden print:inline">${i.qty}</span> ${i.unit}
                    </td>
                    <td class="text-right font-black text-sm">‚Çπ <span id="total-${i.cartId}">${i.total}</span></td>
                    <td class="no-print text-right"><button onclick="removeCartItem(${i.cartId})" class="text-red-400 text-2xl px-2">√ó</button></td>
                </tr>`; 
        });
        document.getElementById('grand-total').innerText = gt.toFixed(2);
    };

    window.removeCartItem = (id) => { cart = cart.filter(x => x.cartId !== id); updateBillTable(); };
    window.clearCart = () => { if(confirm("‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) { cart = []; updateBillTable(); } };

    window.shareOnWhatsApp = () => {
        if(cart.length === 0) return alert("‡¶ñ‡¶æ‡¶≤‡¶ø!");
        let m = `*‡¶Æ‡ßá‡¶Æ‡ßã - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®*\n----------------------------\n`;
        cart.forEach((i, x) => m += `${x+1}. *${i.name}* : ${i.qty} ${i.unit} = ‚Çπ${i.total}\n`);
        m += `----------------------------\n*‡¶Æ‡ßã‡¶ü: ‚Çπ${document.getElementById('grand-total').innerText}*`;
        window.open(`https://wa.me/?text=${encodeURIComponent(m)}`, '_blank');
    };

    showTab('home');
</script>
</body>

</html>
